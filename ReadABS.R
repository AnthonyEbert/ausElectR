library(readr)
library(magrittr)
library(dplyr)
library(stringr)

# Read CSV files
abs2011all <- read_csv("ABSdata/2011Census_areas.csv")
bfiles <- list.files("ABSdata")
bfiles <- grep("2011Census_B", bfiles, value=TRUE)

# Get states and electorate names
tmp <- str_split(abs2011all[["Label"]],", ")
abs2011all$Name <- unlist(lapply(tmp, function(x)x[1]))
abs2011all$State <- unlist(lapply(tmp, function(x)x[2]))
abs2011all$Label <- NULL
rm(tmp)

# Merge all csv files into single data frame
for(i in 1:length(bfiles))
{
  bnew <- read_csv(paste("ABSdata/",bfiles[i],sep=""))
  # Find unique columns
  newcols <- setdiff(names(bnew),names(abs2011all))
  abs2011all <- merge(abs2011all, bnew[,c("region_id",newcols)], 
                   by="region_id")
}  
rm(bfiles,newcols,bnew,i)

# Create a new data frame with a subset of the variables
abs2011 <- data.frame(ID = substr(abs2011all$region_id,4,6))
abs2011$State <- abs2011all$State
abs2011$Area <- abs2011all$`Area sqkm`
abs2011$MedianIncome <- abs2011all$Median_Tot_prsnl_inc_weekly
abs2011$Unemployed <- abs2011all$Percent_Unem_loyment_P
abs2011$Bachelor <- abs2011all$Non_sch_quals_Bchelr_Degree_P / abs2011all$Tot_P_P * 100
abs2011$NoReligion <- abs2011all$No_Religion_P / abs2011all$Tot_P_P * 100
abs2011$Age0_4 <- abs2011all$Age_0_4_yr_P / abs2011all$Tot_P_P * 100
abs2011$Age5_14 <- abs2011all$Age_5_14_yr_P / abs2011all$Tot_P_P * 100
abs2011$Age15_19 <- abs2011all$Age_15_19_yr_P / abs2011all$Tot_P_P * 100
abs2011$Age20_24 <- abs2011all$Age_20_24_yr_P / abs2011all$Tot_P_P * 100
abs2011$Age25_34 <- abs2011all$Age_25_34_yr_P / abs2011all$Tot_P_P * 100
abs2011$Age35_44 <- abs2011all$Age_35_44_yr_P / abs2011all$Tot_P_P * 100
abs2011$Age45_54 <- abs2011all$Age_45_54_yr_P / abs2011all$Tot_P_P * 100
abs2011$Age55_64 <- abs2011all$Age_55_64_yr_P / abs2011all$Tot_P_P * 100
abs2011$Age65_74 <- abs2011all$Age_65_74_yr_P / abs2011all$Tot_P_P * 100
abs2011$Age75_84 <- abs2011all$Age_75_84_yr_P / abs2011all$Tot_P_P * 100
abs2011$Age85plus <- abs2011all$Age_85ov_P / abs2011all$Tot_P_P * 100

